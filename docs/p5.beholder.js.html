<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>p5.beholder.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="",baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="dark" data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">p5.beholder</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="BttxJKzAkHv9-cpuLRVmF"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="P5Beholder.html">P5Beholder</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="HVUGIPVXcSh4tYF-ESyCE"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#p5beholder">p5beholder</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="github-link navbar-item"><a id="repository" href="https://github.com/enricllagostera/p5.beholder" target="_blank">GitHub</a></div><div class="navbar-item"><a id="" href="https://enric.llagostera.com.br/" target="_blank">Made by Enric Llagostera</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">p5.beholder.js</h1></header><article><pre class="prettyprint source lang-js"><code>/**
 * The main class of the library. It should have a single instance per sketch, which is then prepared at the `setup()` function.
 */
class P5Beholder {
  /**
   * Creates an instance of P5Beholder. It is automatically called during p5 loading. Initialization of the library is only compelte after `prepare()` is called on sketch setup (see {@link P5Beholder#prepare}).
   * @class
   * @private
   */
  constructor() {
    // Requires the Beholder system
    this._bh = require("beholder-detection").default;
  }

  /**
   * Sets-up the p5beholder and sketch integration. Adds Beholder to the HTML page at the and initializes it with proper config file.
   * **Important**: must be called once on `setup()`.
   * The config file must use {@link P5Beholder._defaultConfig} as a base.
   *
   * @param {*} [config=P5Beholder._defaultConfig] - Controls how Beholder detection will run.
   * @param {string} [querySelector="#beholder_root"] - Picks an HTML element to be the parent of the Beholder system elements (GUI, etc).
   * @memberof P5Beholder
   */
  prepare(
    config = P5Beholder._defaultConfig,
    querySelector = "#beholder_root"
  ) {
    // Stores the configuration
    this._config = config;
    this._rootQuery = querySelector;
    // Sets up Beholder in the document DOM.
    if (this._rootQuery == null || this._rootQuery == "#beholder_root") {
      let newDiv = document.createElement("div");
      newDiv.setAttribute("id", "beholder_root");
      document.querySelector("body").appendChild(newDiv);
    }
    // Start the detection system
    this._bh.init(this._rootQuery, this._config);
  }

  /**
   *If a marker is present, the mouse button 0 goes down and, when undetected, goes up. The position of the resulting click can be defined, in pixels.
   * @param {number!} [markerId=0] - The id of the marker to check presence.
   * @param {number} [clickX=0] - The X position where of the resulting click.
   * @param {number} [clickY=0] - The Y position where of the resulting click.
   * @memberof P5Beholder
   */
  markerPresenceToMouseClick(markerId = 0, clickX = 0, clickY = 0) {
    let pos = createVector(clickX, clickY);

    const downEvent = new MouseEvent("mousedown", {
      bubbles: true,
      cancelable: true,
      button: 0,
      clientX: pos.x,
      clientY: pos.y,
    });

    const upEvent = new MouseEvent("mouseup", {
      bubbles: true,
      cancelable: true,
      button: 0,
      clientX: pos.x,
      clientY: pos.y,
    });

    this._forwardEventForId(markerId, "markerdetected", downEvent);
    this._forwardEventForId(markerId, "markerundetected", upEvent);
  }

  /**
   * Quick converter between marker presence and keyboard input. When a marker is detected, fires the `keydown` event. Whe the marker is undetected, fires the `keyup` event.
   * @param {number} [markerId=0] - The id of the marker to check.
   * @param {number} [pKeyCode=32] - The number with the keyboard code (from `event.key`).
   * @memberof P5Beholder
   */
  markerPresenceToKey(markerId = 0, pKeyCode = "Space") {
    const downEvent = new KeyboardEvent("keydown", {
      bubbles: true,
      cancelable: true,
      keyCode: pKeyCode,
      which: pKeyCode,
    });

    const upEvent = new KeyboardEvent("keyup", {
      bubbles: true,
      cancelable: true,
      keyCode: pKeyCode,
      which: pKeyCode,
    });

    this._forwardEventForId(markerId, "markerdetected", downEvent);
    this._forwardEventForId(markerId, "markerundetected", upEvent);
  }

  /**
   * Changes the timeout value for all markers.
   * @param {number} [timeout=50] - New time in milliseconds.
   * @memberof P5Beholder
   */
  setMarkersTimeout(timeout = 50) {
    for (let i = 0; i &lt; this._bh.getAllMarkers().length; i++) {
      const item = this._bh.getMarker(i);
      item.timeout = timeout;
    }
  }

  /**
   * Debug functionality for drawing a marker on the canvas.
   * @param {number} [markerId=0] - The id of the marker to draw.
   * @memberof P5Beholder
   */
  debugDrawMarker(markerId = 0) {
    let marker = this._bh.getMarker(markerId);
    if (marker.present == false) return;
    push();
    fill(255, 0, 0);
    stroke(0, 0, 0);
    beginShape();
    vertex(
      this.cameraToCanvasVector(marker.corners[0]).x,
      this.cameraToCanvasVector(marker.corners[0]).y
    );
    vertex(
      this.cameraToCanvasVector(marker.corners[1]).x,
      this.cameraToCanvasVector(marker.corners[1]).y
    );
    vertex(
      this.cameraToCanvasVector(marker.corners[2]).x,
      this.cameraToCanvasVector(marker.corners[2]).y
    );
    vertex(
      this.cameraToCanvasVector(marker.corners[3]).x,
      this.cameraToCanvasVector(marker.corners[3]).y
    );
    endShape(CLOSE);
    fill(0, 255, 0);
    let center = this.cameraToCanvasXY(marker.center.x, marker.center.y);
    ellipse(center.x, center.y, 10, 10);
    textSize(12);
    text(marker.rotation, center.x, center.y + 30, 80, 40);
    pop();
  }

  /**
   * Converts X position from camera to canvas.
   * @param {number} x - Camera X position.
   * @return {number} - Canvas X position.
   * @memberof P5Beholder
   */
  cameraToCanvasX(x) {
    return map(x, 0, this.cameraWidth, 0, width);
  }

  /**
   * Converts Y position from camera to canvas.
   * @param {number} y - Camera Y position.
   * @return {number} - Canvas Y position.
   * @memberof P5Beholder
   */
  cameraToCanvasY(y) {
    return map(y, 0, this.cameraHeight, 0, height);
  }

  /**
   * Converts a position from camera to canvas using a p5.Vector.
   * @param {p5.Vector} coord - p5.Vector with camera position.
   * @return {p5.Vector} - p5.Vector with canvas position.
   * @memberof P5Beholder
   */
  cameraToCanvasVector(coord) {
    return createVector(
      this.cameraToCanvasX(coord.x),
      this.cameraToCanvasY(coord.y)
    );
  }

  /**
   * Converts a position from camera to canvas positions using 2 numbers.
   * @param {number} pX - Camera-relative X value.
   * @param {number} pY - Camera-relative Y value.
   * @return {p5.Vector} - p5.Vector with canvas position.
   * @memberof P5Beholder
   */
  cameraToCanvasXY(pX, pY) {
    return createVector(this.cameraToCanvasX(pX), this.cameraToCanvasY(pY));
  }

  /**
   * Checks if a marker's rotation is within a specified range from a target angle. Useful for detecting things like a crank or spinner with a marker at its center.
   * All angles are in radians.
   * @param {number} markerId - The id of the marker to be checked.
   * @param {number} detectionTargetAngle - The target angle.
   * @param {number} angleRange - The range centers around the target angle. Should be less than PI.
   * @return {true|false}
   * @memberof P5Beholder
   */
  markerRotationInRange(markerId, detectionTargetAngle, angleRange) {
    const m = this._bh.getMarker(markerId);
    const currentAngle = m.present ? m.rotation : 0;
    return this.angleInRange(currentAngle, detectionTargetAngle, angleRange);
  }

  /**
   * Checks if the current angle is within a defined range from a target angle. All angles are in radians.
   * @param {number} currentAngle - Value to be checked.
   * @param {number} detectionTargetAngle - The target angle.
   * @param {number} angleRange - The range centers around the target angle. Should be less than PI.
   * @return {true|false}
   * @memberof P5Beholder
   */
  angleInRange(currentAngle, detectionTargetAngle, angleRange) {
    const av = p5.Vector.fromAngle(currentAngle, 1);
    const dv = p5.Vector.fromAngle(detectionTargetAngle, 1);
    const da = dv.angleBetween(av);
    return abs(da) &lt;= angleRange / 2;
  }

  /// Wrappers to Beholder API

  getMarker(markerId) {
    return this._bh.getMarker(markerId);
  }

  /// PRIVATE METHODS AND PROPERTIES

  /**
   * An object holding camera, detection, feed and overlay default options for the Beholder detection system.
   * @static
   * @memberof P5Beholder
   * @example
   * // Structure of the default configuration object
{
  camera_params: {
    videoSize: 0, // The video size values map to the following [320 x 240, 640 x 480, 1280 x 720, 1920 x 1080]
    rearCamera: false, // Boolean value for defaulting to the rear facing camera. Only works on mobile
    torch: false, // Boolean value for if torch/flashlight is on. Only works for rear facing mobile cameras. Can only be set from init
  },
  detection_params: {
    minMarkerDistance: 10,
    minMarkerPerimeter: 0.2,
    maxMarkerPerimeter: 0.8,
    sizeAfterPerspectiveRemoval: 49,
  },
  feed_params: {
    contrast: 0,
    brightness: 0,
    grayscale: 0,
    flip: false,
  },
  overlay_params: {
    present: true, // Determines if the Beholder overlay will display or be invisible entirely via display: none
    hide: true, // Determines if the overlay should be hidden on the left of the screen or visible
  },
}
   */
  static _defaultConfig = {
    camera_params: {
      videoSize: 0, // The video size values map to the following [320 x 240, 640 x 480, 1280 x 720, 1920 x 1080]
      rearCamera: false, // Boolean value for defaulting to the rear facing camera. Only works on mobile
      torch: false, // Boolean value for if torch/flashlight is on. Only works for rear facing mobile cameras. Can only be set from init
    },
    detection_params: {
      minMarkerDistance: 10,
      minMarkerPerimeter: 0.2,
      maxMarkerPerimeter: 0.8,
      sizeAfterPerspectiveRemoval: 49,
    },
    feed_params: {
      contrast: 0,
      brightness: 0,
      grayscale: 0,
      flip: false,
    },
    overlay_params: {
      present: true, // Determines if the Beholder overlay will display or be invisible entirely via display: none
      hide: true, // Determines if the overlay should be hidden on the left of the screen or visible
    },
  };

  _forwardEventForId(markerId, eventName, destEvt) {
    window.addEventListener(eventName, (srcEvt) => {
      if (srcEvt.detail.id == markerId) {
        window.dispatchEvent(destEvt);
      }
    });
  }
}

/**
 * Global instance of the P5Beholder class.
 * @global
 */
global.p5beholder = new P5Beholder();

// Register preupdate on p5 flow. Thsi needs to be outside the class because of p5 way of dealing with registering methods (i.e. it loses the `this` binding). So, the preUpdate changes things on the global instance just created. Not very nice, but works.
global.p5.prototype.registerMethod("pre", _beholderPreUpdate);

function _beholderPreUpdate() {
  const p5b = global.p5beholder;
  p5b.cameraWidth = p5b._bh.getVideo().width;
  p5b.cameraHeight = p5b._bh.getVideo().height;

  let prevPresence = p5b._bh.getAllMarkers().map((m) => m.present);

  p5b._bh.update();

  let currPresence = p5b._bh.getAllMarkers().map((m) => m.present);

  if (frameCount == 1) {
    prevPresence = [false];
    currPresence = [false];
  }

  prevPresence.forEach((prevState, index) => {
    const currState = currPresence[index];

    if (prevState == false &amp;&amp; currState == true) {
      let evDetected = new CustomEvent("markerdetected", {
        detail: { id: index, marker: p5b._bh.getMarker(index) },
      });
      window.dispatchEvent(evDetected);
      return;
    }
    if (prevState == true &amp;&amp; currState == false) {
      let evUndetected = new CustomEvent("markerundetected", {
        detail: { id: index, marker: p5b._bh.getMarker(index) },
      });
      window.dispatchEvent(evUndetected);
      return;
    }
  });
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">p5.beholder</a><div class="mobile-nav-links"><div class="github-link navbar-item"><a id="repository-mobile" href="https://github.com/enricllagostera/p5.beholder" target="_blank">GitHub</a></div><div class="navbar-item"><a id="" href="https://enric.llagostera.com.br/" target="_blank">Made by Enric Llagostera</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="BttxJKzAkHv9-cpuLRVmF"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="P5Beholder.html">P5Beholder</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="HVUGIPVXcSh4tYF-ESyCE"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#p5beholder">p5beholder</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>